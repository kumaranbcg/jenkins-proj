pipeline {
    agent any
    environment {
        BRANCH_NAME = "${GIT_BRANCH.replaceAll('origin/', '')}"
    }
    stages {
        stage("Env Variables") {
            steps {
                script {
					env.ECRREPOURI = "839316227584.dkr.ecr.ap-south-1.amazonaws.com/idp-vca-service"
					env.DOCKERPUSHURL = "https://839316227584.dkr.ecr.ap-south-1.amazonaws.com/idp-vca-service"
					sh "cd ${env.WORKSPACE}"
					echo "branch name : ${env.BRANCH_NAME}"
					env.COMMIT = sh(returnStdout: true, script: 'echo $(git rev-parse --short HEAD)').trim()
					env.GIT_COMMIT_MSG = sh (script: 'git log -1 --pretty=%B ${GIT_COMMIT}', returnStdout: true).trim()
					env.GIT_AUTHOR = sh (script: 'git log -1 --pretty=%cn ${GIT_COMMIT}', returnStdout: true).trim()                    
                    env.TAG = "${env.BRANCH_NAME}" + "-" + "${BUILD_NUMBER}"
					echo "Tag : ${env.TAG}"
                    env.IMAGE = "${env.ECRREPOURI}" + ":" + "${env.TAG}"
                    
                } //script end           
            } //steps end
        } // env Variables stage end
        
            stage("Docker build") {
                steps {
                    sh """ 
                        docker build . -t ${env.ECRREPOURI}:${env.TAG} -f ${env.WORKSPACE}/deployment/Dockerfile
                    """
                } // steps end
            } // docker build stage end

        stage("Docker push to AWS ECR") {
            steps
              {
                  script {
                    withAWS(region: 'ap-south-1', credentials: 'aws-creds') {
                        sh "${ecrLogin()}"
                        docker.image("${env.IMAGE}").push()
                        sh "docker rmi ${env.IMAGE} | true"
                    }
                }
            } // steps end
        } //  docker push stage end

        // stage("Replacing Yaml Variables") {
        //     steps {
        //         sh """      
        //             sed -i "s|CONTAINER_IMAGE|${env.IMAGE}|g" ${env.FILENAME}
        //             sed -i "s|BRANCH_NAMESPACE|${env.BRANCH_NAME}|g" ${env.FILENAME}
        //         """
        //     } //steps end
        // } //Replacing yaml Variables stage end

        stage("Deploy in ECS") {
            steps {
               script{                 
                       withAWS(region: 'ap-south-1', credentials: 'aws-creds') {
                        def updateService = "aws ecs update-service --service myservice --cluster mycluster --force-new-deployment"
                        def runUpdateService = sh(returnStdout: true, script: updateService)
                        def serviceStable = "aws ecs wait services-stable --service $internationalService --cluster $internationalCluster"
                        sh(returnStdout: true, script: serviceStable)
                        // put all your slack messaging here
                    }              
                } //script end
            } // steps end
        } //  k8S deployment file deployment stage end
    } //stages end
} //pipeline end